---
import Layout from "../layouts/Layout.astro";
import HeroShell from "../components/HeroShell.astro";

// Config
const PEOPLE = 2;
const CURRENCY = "‚Ç¨";

// Datos (hoteles = total reserva; lo dem√°s = por persona)
const HOTELS_TOTAL = [
  { name: "The Sebali Resort (Ubud)", dates: "22‚Äì25 jul", note: "Villa privada (cumple de Susan)", amount: 403 },
  { name: "Hideaway Villas (Uluwatu)", dates: "25‚Äì27 jul", note: "Piscina privada", amount: 208 },
  { name: "Montigo Resorts (Seminyak)", dates: "27‚Äì29 jul", note: "Cerca de Potato Head", amount: 164 },
  { name: "Ponte Villas (Gili T)", dates: "29 jul‚Äì01 ago", note: "Full Moon strategy", amount: 340 },
  { name: "Pearl of Trawangan (Gili T)", dates: "01‚Äì04 ago", note: "Desconexi√≥n", amount: 339 },
  { name: "Amber Lombok (Lombok)", dates: "04‚Äì07 ago", note: "Playas v√≠rgenes", amount: 291 },
];

const TRANSPORT_PER_PERSON = [
  { name: "Vuelos internacionales BCN ‚áÑ Yakarta (escala Yeda)", amountPP: 597 },
  { name: "Bilbao ‚áÑ Barcelona (i/v)", amountPP: 80 },
  { name: "Vuelo Yakarta ‚Üí Bali", amountPP: 80 },
  { name: "Vuelo Lombok ‚Üí Yakarta", amountPP: 80 },
  { name: "Ferry a Gili", amountPP: 35 },
];

const INSURANCE_PER_PERSON = [{ name: "Seguro IATI", amountPP: 58 }];

// Totales
const hotelsTotal = HOTELS_TOTAL.reduce((s, x) => s + x.amount, 0);
const transportTotal = TRANSPORT_PER_PERSON.reduce((s, x) => s + x.amountPP * PEOPLE, 0);
const insuranceTotal = INSURANCE_PER_PERSON.reduce((s, x) => s + x.amountPP * PEOPLE, 0);

const grandTotal = hotelsTotal + transportTotal + insuranceTotal;
const perPersonTotal = hotelsTotal / PEOPLE + TRANSPORT_PER_PERSON.reduce((s, x) => s + x.amountPP, 0) + INSURANCE_PER_PERSON.reduce((s, x) => s + x.amountPP, 0);

// Datos para el script cliente (donut + porcentajes)
const chartData = [
  { id: "hotels", label: "Hoteles", value: hotelsTotal },
  { id: "transport", label: "Transportes", value: transportTotal },
  { id: "insurance", label: "Seguros", value: insuranceTotal },
];

const payload = {
  people: PEOPLE,
  currency: CURRENCY,
  totals: { hotelsTotal, transportTotal, insuranceTotal, grandTotal, perPersonTotal },
  chart: chartData,
  hotels: HOTELS_TOTAL,
  transportPP: TRANSPORT_PER_PERSON,
  insurancePP: INSURANCE_PER_PERSON,
};
---

<Layout title="Presupuesto (secreto) | Borja & Susan" description="Desglose de precios cerrados de la luna de miel (p√°gina no enlazada).">
  <HeroShell slot="hero" />

  <div class="pt-10 pb-24 max-w-6xl mx-auto px-4 relative z-20">
    <header class="text-center mb-12">
      <span class="text-amber-400 font-black tracking-widest uppercase text-sm mb-4 block">Presupuesto</span>
      <h1 class="text-4xl md:text-6xl font-[900] text-white mb-4">Costes cerrados</h1>
      <p class="text-zinc-400 text-base md:text-lg max-w-2xl mx-auto">
        Desglose completo, claro y con visuales para ver d√≥nde se va el dinero. Spoiler: a cosas bonitas.
      </p>

      <div class="mt-6 inline-flex flex-wrap items-center justify-center gap-2 text-xs">
        <span class="px-3 py-1.5 rounded-full border border-white/10 bg-white/5 text-zinc-300">
          üë• {PEOPLE} personas
        </span>
        <span class="px-3 py-1.5 rounded-full border border-white/10 bg-white/5 text-zinc-300">
          üè® Hoteles = total reserva
        </span>
        <span class="px-3 py-1.5 rounded-full border border-white/10 bg-white/5 text-zinc-300">
          ‚úàÔ∏è/üõ°Ô∏è = por persona
        </span>
      </div>
    </header>

    <!-- Resumen -->
    <section class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-10">
      <div class="lg:col-span-2 p-6 rounded-2xl border border-white/10 bg-zinc-900/60 backdrop-blur-sm">
        <div class="flex items-start justify-between gap-4">
          <div>
            <h2 class="text-xl md:text-2xl font-[900] text-white">Resumen</h2>
            <p class="text-zinc-400 text-sm mt-1">Totales finales (sin estimaciones).</p>
          </div>
          <div class="text-right">
            <p class="text-[10px] uppercase tracking-widest text-zinc-500 font-black">Personas</p>
            <p class="text-white font-[900] text-lg">{PEOPLE}</p>
          </div>
        </div>

        <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="p-4 rounded-xl border border-white/10 bg-black/30">
            <p class="text-[10px] uppercase tracking-widest text-zinc-500 font-black">Total viaje</p>
            <p id="grandTotal" class="mt-1 text-3xl font-[900] text-white">‚Äî</p>
            <p class="text-xs text-zinc-400 mt-1">Suma de hoteles + transportes + seguros.</p>
          </div>
          <div class="p-4 rounded-xl border border-white/10 bg-black/30">
            <p class="text-[10px] uppercase tracking-widest text-zinc-500 font-black">Total por persona</p>
            <p id="perPersonTotal" class="mt-1 text-3xl font-[900] text-amber-300">‚Äî</p>
            <p class="text-xs text-zinc-400 mt-1">Incluye la parte proporcional de hoteles.</p>
          </div>
        </div>

        <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-3">
          <div class="p-4 rounded-xl border border-white/10 bg-white/5">
            <p class="text-[10px] uppercase tracking-widest text-zinc-500 font-black">Hoteles</p>
            <p id="hotelsTotal" class="text-white font-[900] text-xl mt-1">‚Äî</p>
          </div>
          <div class="p-4 rounded-xl border border-white/10 bg-white/5">
            <p class="text-[10px] uppercase tracking-widest text-zinc-500 font-black">Transportes</p>
            <p id="transportTotal" class="text-white font-[900] text-xl mt-1">‚Äî</p>
          </div>
          <div class="p-4 rounded-xl border border-white/10 bg-white/5">
            <p class="text-[10px] uppercase tracking-widest text-zinc-500 font-black">Seguros</p>
            <p id="insuranceTotal" class="text-white font-[900] text-xl mt-1">‚Äî</p>
          </div>
        </div>
      </div>

      <!-- Donut + leyenda -->
      <div class="p-6 rounded-2xl border border-white/10 bg-zinc-900/60 backdrop-blur-sm">
        <h2 class="text-xl font-[900] text-white">Distribuci√≥n</h2>
        <p class="text-zinc-400 text-sm mt-1">C√≥mo se reparte el total.</p>

        <div class="mt-5 flex items-center gap-4">
          <div class="shrink-0">
            <div id="donutWrap" class="w-32 h-32"></div>
          </div>
          <div id="donutLegend" class="flex-1 space-y-2"></div>
        </div>

        <div class="mt-6 space-y-3" id="categoryBars"></div>
      </div>
    </section>

    <!-- Categor√≠a: Hoteles -->
    <section class="p-6 rounded-2xl border border-white/10 bg-zinc-900/40 backdrop-blur-sm">
      <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-3">
        <div>
          <h2 class="text-2xl md:text-3xl font-[900] text-white">Hoteles</h2>
          <p class="text-zinc-400 text-sm mt-1">Precios totales de reserva.</p>
        </div>
        <div class="text-right">
          <p class="text-[10px] uppercase tracking-widest text-zinc-500 font-black">Subtotal</p>
          <p id="hotelsSubtotal" class="text-white font-[900] text-xl">‚Äî</p>
        </div>
      </div>

      <div class="mt-5 h-px bg-gradient-to-r from-emerald-500/25 via-emerald-500/10 to-transparent"></div>

      <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
        {HOTELS_TOTAL.map((h) => (
          <article class="p-5 rounded-2xl border border-white/10 bg-black/30 hover:bg-white/5 transition-all">
            <div class="flex items-start justify-between gap-3">
              <div>
                <div class="flex flex-wrap items-center gap-2">
                  <span class="text-[10px] uppercase tracking-widest text-zinc-500 font-black">{h.dates}</span>
                  <span class="px-2 py-1 rounded-md bg-emerald-500/10 text-emerald-300 border border-emerald-500/20 text-[10px] font-black uppercase tracking-widest">
                    Total
                  </span>
                </div>
                <h3 class="mt-2 text-lg font-bold text-white">{h.name}</h3>
                {h.note ? <p class="text-zinc-400 text-sm mt-1">{h.note}</p> : null}
              </div>

              <div class="text-right shrink-0">
                <p class="text-[10px] uppercase tracking-widest text-zinc-500 font-black">Importe</p>
                <p class="text-white font-[900] text-xl">{h.amount}{CURRENCY}</p>
              </div>
            </div>

            <div class="mt-4">
              <div class="flex items-center justify-between">
                <span class="text-[10px] uppercase tracking-widest text-zinc-500 font-black">Peso en Hoteles</span>
                <span class="text-[10px] uppercase tracking-widest text-zinc-500 font-black" data-hotel-pct={h.amount}>‚Äî</span>
              </div>
              <div class="mt-2 h-2 rounded-full bg-white/10 overflow-hidden">
                <div class="h-full bg-gradient-to-r from-emerald-500 to-emerald-200" style="width:0%" data-hotel-bar={h.amount}></div>
              </div>
            </div>
          </article>
        ))}
      </div>
    </section>

    <!-- Categor√≠a: Transportes -->
    <section class="mt-10 p-6 rounded-2xl border border-white/10 bg-zinc-900/40 backdrop-blur-sm">
      <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-3">
        <div>
          <h2 class="text-2xl md:text-3xl font-[900] text-white">Transportes</h2>
          <p class="text-zinc-400 text-sm mt-1">Precios por persona (mostrados) y total (calculado para {PEOPLE}).</p>
        </div>
        <div class="text-right">
          <p class="text-[10px] uppercase tracking-widest text-zinc-500 font-black">Subtotal</p>
          <p id="transportSubtotal" class="text-white font-[900] text-xl">‚Äî</p>
        </div>
      </div>

      <div class="mt-5 h-px bg-gradient-to-r from-sky-500/25 via-sky-500/10 to-transparent"></div>

      <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
        {TRANSPORT_PER_PERSON.map((t) => (
          <article class="p-5 rounded-2xl border border-white/10 bg-black/30 hover:bg-white/5 transition-all">
            <div class="flex items-start justify-between gap-3">
              <div>
                <div class="flex flex-wrap items-center gap-2">
                  <span class="px-2 py-1 rounded-md bg-sky-500/10 text-sky-300 border border-sky-500/20 text-[10px] font-black uppercase tracking-widest">
                    Por persona
                  </span>
                </div>
                <h3 class="mt-2 text-lg font-bold text-white">{t.name}</h3>
                <p class="text-zinc-400 text-sm mt-1">
                  Total para {PEOPLE}: <span class="text-zinc-200 font-bold">{t.amountPP * PEOPLE}{CURRENCY}</span>
                </p>
              </div>

              <div class="text-right shrink-0">
                <p class="text-[10px] uppercase tracking-widest text-zinc-500 font-black">P/P</p>
                <p class="text-white font-[900] text-xl">{t.amountPP}{CURRENCY}</p>
              </div>
            </div>

            <div class="mt-4">
              <div class="flex items-center justify-between">
                <span class="text-[10px] uppercase tracking-widest text-zinc-500 font-black">Peso en Transportes</span>
                <span class="text-[10px] uppercase tracking-widest text-zinc-500 font-black" data-transport-pct={t.amountPP}>‚Äî</span>
              </div>
              <div class="mt-2 h-2 rounded-full bg-white/10 overflow-hidden">
                <div class="h-full bg-gradient-to-r from-sky-500 to-sky-200" style="width:0%" data-transport-bar={t.amountPP}></div>
              </div>
            </div>
          </article>
        ))}
      </div>
    </section>

    <!-- Categor√≠a: Seguros -->
    <section class="mt-10 p-6 rounded-2xl border border-white/10 bg-zinc-900/40 backdrop-blur-sm">
      <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-3">
        <div>
          <h2 class="text-2xl md:text-3xl font-[900] text-white">Seguros</h2>
          <p class="text-zinc-400 text-sm mt-1">Precio por persona y total para {PEOPLE}.</p>
        </div>
        <div class="text-right">
          <p class="text-[10px] uppercase tracking-widest text-zinc-500 font-black">Subtotal</p>
          <p id="insuranceSubtotal" class="text-white font-[900] text-xl">‚Äî</p>
        </div>
      </div>

      <div class="mt-5 h-px bg-gradient-to-r from-amber-500/25 via-amber-500/10 to-transparent"></div>

      <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
        {INSURANCE_PER_PERSON.map((s) => (
          <article class="p-5 rounded-2xl border border-white/10 bg-black/30 hover:bg-white/5 transition-all">
            <div class="flex items-start justify-between gap-3">
              <div>
                <div class="flex flex-wrap items-center gap-2">
                  <span class="px-2 py-1 rounded-md bg-amber-500/10 text-amber-300 border border-amber-500/20 text-[10px] font-black uppercase tracking-widest">
                    Por persona
                  </span>
                </div>
                <h3 class="mt-2 text-lg font-bold text-white">{s.name}</h3>
                <p class="text-zinc-400 text-sm mt-1">
                  Total para {PEOPLE}: <span class="text-zinc-200 font-bold">{s.amountPP * PEOPLE}{CURRENCY}</span>
                </p>
              </div>

              <div class="text-right shrink-0">
                <p class="text-[10px] uppercase tracking-widest text-zinc-500 font-black">P/P</p>
                <p class="text-white font-[900] text-xl">{s.amountPP}{CURRENCY}</p>
              </div>
            </div>
          </article>
        ))}
      </div>
    </section>

    <!-- Tabla final -->
    <section class="mt-10 p-6 rounded-2xl border border-white/10 bg-zinc-900/40 backdrop-blur-sm">
      <h2 class="text-2xl md:text-3xl font-[900] text-white">Desglose final</h2>
      <p class="text-zinc-400 text-sm mt-1">Todo junto, sin magia y sin sliders.</p>

      <div class="mt-6 overflow-x-auto rounded-2xl border border-white/10 bg-black/30">
        <table class="min-w-full text-sm">
          <thead class="text-zinc-300">
            <tr class="border-b border-white/10">
              <th class="text-left px-4 py-3 font-black text-[10px] uppercase tracking-widest text-zinc-500">Concepto</th>
              <th class="text-left px-4 py-3 font-black text-[10px] uppercase tracking-widest text-zinc-500">Tipo</th>
              <th class="text-right px-4 py-3 font-black text-[10px] uppercase tracking-widest text-zinc-500">P/P</th>
              <th class="text-right px-4 py-3 font-black text-[10px] uppercase tracking-widest text-zinc-500">Total</th>
            </tr>
          </thead>
          <tbody class="text-zinc-200">
            {HOTELS_TOTAL.map((h) => (
              <tr class="border-b border-white/5">
                <td class="px-4 py-3">{h.name} <span class="text-zinc-500 text-xs">({h.dates})</span></td>
                <td class="px-4 py-3 text-zinc-400">Total reserva</td>
                <td class="px-4 py-3 text-right text-zinc-500">‚Äî</td>
                <td class="px-4 py-3 text-right font-bold">{h.amount}{CURRENCY}</td>
              </tr>
            ))}

            {TRANSPORT_PER_PERSON.map((t) => (
              <tr class="border-b border-white/5">
                <td class="px-4 py-3">{t.name}</td>
                <td class="px-4 py-3 text-zinc-400">Por persona</td>
                <td class="px-4 py-3 text-right font-bold">{t.amountPP}{CURRENCY}</td>
                <td class="px-4 py-3 text-right font-bold">{t.amountPP * PEOPLE}{CURRENCY}</td>
              </tr>
            ))}

            {INSURANCE_PER_PERSON.map((s) => (
              <tr class="border-b border-white/5">
                <td class="px-4 py-3">{s.name}</td>
                <td class="px-4 py-3 text-zinc-400">Por persona</td>
                <td class="px-4 py-3 text-right font-bold">{s.amountPP}{CURRENCY}</td>
                <td class="px-4 py-3 text-right font-bold">{s.amountPP * PEOPLE}{CURRENCY}</td>
              </tr>
            ))}
          </tbody>
          <tfoot>
            <tr class="border-t border-white/10">
              <td class="px-4 py-4 font-[900] text-white">Totales</td>
              <td class="px-4 py-4 text-zinc-500 text-xs">‚Äî</td>
              <td class="px-4 py-4 text-right font-[900] text-amber-300" id="tfootPerPerson">‚Äî</td>
              <td class="px-4 py-4 text-right font-[900] text-white" id="tfootGrand">‚Äî</td>
            </tr>
          </tfoot>
        </table>
      </div>
    </section>
  </div>

  <script define:vars={{ payload }}>
    const fmt = (n, currency = "‚Ç¨") =>
      new Intl.NumberFormat("es-ES", { style: "currency", currency: "EUR" })
        .format(Number(n) || 0)
        .replace("‚Ç¨", currency);

    const { people, currency, totals, chart, hotels, transportPP } = payload;

    // Pintar n√∫meros del resumen
    const set = (id, value) => {
      const el = document.getElementById(id);
      if (el) el.textContent = value;
    };

    set("grandTotal", fmt(totals.grandTotal, currency));
    set("perPersonTotal", fmt(totals.perPersonTotal, currency));
    set("hotelsTotal", fmt(totals.hotelsTotal, currency));
    set("transportTotal", fmt(totals.transportTotal, currency));
    set("insuranceTotal", fmt(totals.insuranceTotal, currency));
    set("hotelsSubtotal", fmt(totals.hotelsTotal, currency));
    set("transportSubtotal", fmt(totals.transportTotal, currency));
    set("insuranceSubtotal", fmt(totals.insuranceTotal, currency));
    set("tfootPerPerson", fmt(totals.perPersonTotal, currency));
    set("tfootGrand", fmt(totals.grandTotal, currency));

    // Barras por categor√≠a (en panel derecho)
    const categoryBars = document.getElementById("categoryBars");
    const total = totals.grandTotal || 1;

    const catMeta = {
      hotels: { bar: "bg-gradient-to-r from-emerald-500 to-emerald-200" },
      transport: { bar: "bg-gradient-to-r from-sky-500 to-sky-200" },
      insurance: { bar: "bg-gradient-to-r from-amber-500 to-amber-200" },
    };

    if (categoryBars) {
      categoryBars.innerHTML = "";
      for (const c of chart) {
        const pct = Math.max(0, Math.min(100, (c.value / total) * 100));
        const row = document.createElement("div");
        row.className = "space-y-2";
        row.innerHTML = `
          <div class="flex items-center justify-between">
            <span class="text-sm text-white font-bold">${c.label}</span>
            <span class="text-sm text-zinc-300 font-[900]">${fmt(c.value, currency)}</span>
          </div>
          <div class="h-2 rounded-full bg-white/10 overflow-hidden">
            <div class="h-full ${catMeta[c.id]?.bar ?? "bg-white/70"}" style="width:${pct.toFixed(1)}%"></div>
          </div>
          <div class="flex items-center justify-between text-[10px] uppercase tracking-widest text-zinc-500 font-black">
            <span>${pct.toFixed(1)}%</span>
            <span>del total</span>
          </div>
        `;
        categoryBars.appendChild(row);
      }
    }

    // Donut SVG sin librer√≠as
    const donutWrap = document.getElementById("donutWrap");
    const legend = document.getElementById("donutLegend");

    function donutSegments(data) {
      // Donut basado en stroke-dasharray
      const r = 46;
      const c = 2 * Math.PI * r;
      let acc = 0;

      const colors = {
        hotels: "stroke-emerald-400",
        transport: "stroke-sky-400",
        insurance: "stroke-amber-400",
      };

      const segs = data.map((d) => {
        const frac = (d.value / total);
        const len = c * frac;
        const dash = `${len} ${c - len}`;
        const offset = c * (1 - acc);
        acc += frac;
        return { ...d, dash, offset, cls: colors[d.id] ?? "stroke-white" };
      });

      return { r, c, segs };
    }

    if (donutWrap && legend) {
      const { r, segs } = donutSegments(chart);

      donutWrap.innerHTML = `
        <svg viewBox="0 0 120 120" class="w-32 h-32">
          <circle cx="60" cy="60" r="${r}" fill="none" stroke="rgba(255,255,255,0.08)" stroke-width="12"></circle>
          ${segs.map(s => `
            <circle
              cx="60" cy="60" r="${r}"
              fill="none"
              stroke-width="12"
              stroke-linecap="round"
              class="${s.cls}"
              stroke-dasharray="${s.dash}"
              stroke-dashoffset="${s.offset}"
              transform="rotate(-90 60 60)"
            ></circle>
          `).join("")}
          <circle cx="60" cy="60" r="34" fill="rgba(0,0,0,0.25)"></circle>
          <text x="60" y="58" text-anchor="middle" class="fill-white" style="font-weight:900; font-size:12px;">TOTAL</text>
          <text x="60" y="76" text-anchor="middle" class="fill-zinc-300" style="font-weight:900; font-size:12px;">${fmt(totals.grandTotal, currency)}</text>
        </svg>
      `;

      legend.innerHTML = "";
      for (const c of chart) {
        const pct = Math.max(0, Math.min(100, (c.value / total) * 100));
        const dotCls =
          c.id === "hotels" ? "bg-emerald-400" :
          c.id === "transport" ? "bg-sky-400" :
          "bg-amber-400";

        const row = document.createElement("div");
        row.className = "flex items-center justify-between gap-3";
        row.innerHTML = `
          <div class="flex items-center gap-2">
            <span class="w-2.5 h-2.5 rounded-full ${dotCls}"></span>
            <span class="text-sm text-white font-bold">${c.label}</span>
          </div>
          <span class="text-xs text-zinc-400 font-black">${pct.toFixed(1)}%</span>
        `;
        legend.appendChild(row);
      }
    }

    // Barras internas: peso dentro de Hoteles
    const hotelsTotal = totals.hotelsTotal || 1;
    document.querySelectorAll("[data-hotel-pct]").forEach((el) => {
      const amount = Number(el.getAttribute("data-hotel-pct") || 0);
      const pct = Math.max(0, Math.min(100, (amount / hotelsTotal) * 100));
      el.textContent = `${pct.toFixed(1)}%`;
    });

    document.querySelectorAll("[data-hotel-bar]").forEach((el) => {
      const amount = Number(el.getAttribute("data-hotel-bar") || 0);
      const pct = Math.max(0, Math.min(100, (amount / hotelsTotal) * 100));
      el.style.width = `${pct.toFixed(1)}%`;
    });

    // Barras internas: peso dentro de Transportes (calculado por persona)
    const transportTotal = totals.transportTotal || 1;
    document.querySelectorAll("[data-transport-pct]").forEach((el) => {
      const amountPP = Number(el.getAttribute("data-transport-pct") || 0);
      const contribution = amountPP * people;
      const pct = Math.max(0, Math.min(100, (contribution / transportTotal) * 100));
      el.textContent = `${pct.toFixed(1)}%`;
    });

    document.querySelectorAll("[data-transport-bar]").forEach((el) => {
      const amountPP = Number(el.getAttribute("data-transport-bar") || 0);
      const contribution = amountPP * people;
      const pct = Math.max(0, Math.min(100, (contribution / transportTotal) * 100));
      el.style.width = `${pct.toFixed(1)}%`;
    });
  </script>
</Layout>
