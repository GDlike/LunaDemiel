---
import Layout from '../layouts/Layout.astro';
import HeroShell from '../components/HeroShell.astro';
---

<Layout title="Mapa del viaje | Borja & Susan">
  <HeroShell slot="hero"></HeroShell>

  {/* FIX: este div estaba cerrado demasiado pronto. Ahora envuelve TODO el contenido. */}
  <div class="pt-10 pb-20 px-4 max-w-5xl mx-auto relative z-20 space-y-20">
    <div class="text-center">
      <span class="text-amber-400 font-[900] tracking-[0.3em] uppercase text-xs mb-4 block animate-pulse">Ubicaci√≥n mapa</span>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-10">
      <div class="lg:col-span-1">
        <div class="bg-zinc-900/90 backdrop-blur-2xl border border-white/10 p-8 rounded-[2.5rem] lg:sticky lg:top-32 shadow-2xl">
          <h3 class="text-amber-500 font-[900] text-2xl mb-8 flex items-center gap-3 italic">
            üìç Paradas
          </h3>

          <div class="space-y-6 text-left" id="stops">
            {[
              { name: "Ubud", desc: "Selva profunda y arrozales." },
              { name: "Uluwatu", desc: "Acantilados y templos m√°gicos." },
              { name: "Seminyak", desc: "Beach clubs y atardeceres." },
              { name: "Gili Trawangan", desc: "Buceo con tortugas marinas." },
              { name: "Lombok", desc: "Paz absoluta y playas v√≠rgenes." }
            ].map((loc) => (
              <button
                type="button"
                data-stop={loc.name}
                class="w-full text-left relative pl-8 border-l-2 border-amber-500/20 group focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-500/60 rounded-xl py-1"
              >
                <div class="absolute -left-[9px] top-2 w-4 h-4 bg-amber-500 rounded-full shadow-[0_0_10px_#f59e0b]"></div>
                <p class="text-white font-black text-sm uppercase italic tracking-wider">{loc.name}</p>
                <p class="text-zinc-500 text-xs mt-1 leading-relaxed">{loc.desc}</p>
              </button>
            ))}
          </div>

          <p class="mt-8 text-zinc-500 text-xs leading-relaxed">
            Tip: pincha una parada y el mapa se mueve. Porque somos civilizaci√≥n, no cavern√≠colas.
          </p>
        </div>
      </div>

      <div class="lg:col-span-2">
        <div class="relative w-full h-[500px] md:h-[750px] bg-zinc-950 rounded-[3rem] p-1 shadow-2xl overflow-hidden border border-white/10">
          <!-- Loading state -->
          <div id="map-loading" class="absolute inset-0 z-10 flex items-center justify-center bg-zinc-950 rounded-[2.8rem] transition-opacity duration-300">
            <div class="text-center">
              <div class="inline-block w-12 h-12 border-4 border-amber-500/30 border-t-amber-500 rounded-full animate-spin mb-4"></div>
              <p class="text-zinc-400 text-sm font-bold">Cargando mapa...</p>
            </div>
          </div>
          
          <div id="map" class="w-full h-full rounded-[2.8rem] z-0 bg-zinc-950" aria-label="Mapa interactivo del viaje"></div>

          <!-- Error state (oculto por defecto) -->
          <div id="map-error" class="absolute inset-0 z-20 hidden items-center justify-center bg-zinc-950 rounded-[2.8rem]">
            <div class="text-center px-4">
              <p class="text-red-400 text-xl mb-2">‚ö†Ô∏è</p>
              <p class="text-zinc-300 font-bold mb-2">No se pudo cargar el mapa</p>
              <button onclick="loadMap()" class="text-amber-500 hover:text-amber-400 text-sm underline">Intentar de nuevo</button>
            </div>
          </div>

          <div class="absolute bottom-6 right-6 z-[1000] pointer-events-none hidden md:block">
            <span class="bg-black/80 backdrop-blur-md text-amber-500 text-[9px] px-4 py-1.5 rounded-full border border-amber-500/30 uppercase tracking-[0.2em] font-black">
              üñ±Ô∏è Scroll para Zoom
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script is:inline>
    let mapInitTries = 0;

    function cleanupMap() {
      if (window.leafletMap) {
        try { window.leafletMap.remove(); } catch (e) {}
        window.leafletMap = null;
      }
      const el = document.getElementById('map');
      if (el) {
        el.dataset.mapInited = "0";
        el.innerHTML = "";
      }
      mapInitTries = 0;
      // Limpia referencias para evitar ‚Äúfantasmas‚Äù
      window.leafletMarkersByName = null;
      window.leafletRouteLine = null;
    }

    function escapeHtml(str) {
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function loadMap() {
      const el = document.getElementById('map');
      const loadingEl = document.getElementById('map-loading');
      const errorEl = document.getElementById('map-error');
      
      if (!el) return;

      // Ocultar error si est√° visible
      if (errorEl) {
        errorEl.classList.add('hidden');
        errorEl.classList.remove('flex');
      }

      // Mostrar loading
      if (loadingEl) {
        loadingEl.classList.remove('opacity-0');
        loadingEl.classList.add('opacity-100', 'flex');
      }

      if (el.dataset.mapInited === "1") {
        if (loadingEl) {
          loadingEl.classList.add('opacity-0');
          setTimeout(() => loadingEl.classList.add('hidden'), 300);
        }
        return;
      }

      if (typeof window.L === 'undefined') {
        if (mapInitTries < 50) {
          mapInitTries++;
          setTimeout(loadMap, 50);
        } else {
          // Timeout: mostrar error
          if (loadingEl) loadingEl.classList.add('hidden');
          if (errorEl) {
            errorEl.classList.remove('hidden');
            errorEl.classList.add('flex');
          }
        }
        return;
      }

      if (window.leafletMap) {
        try { window.leafletMap.remove(); } catch (e) {}
        window.leafletMap = null;
      }

      el.dataset.mapInited = "1";

      try {
        const map = window.L.map('map', {
          scrollWheelZoom: true,
          zoomControl: false,
          attributionControl: false
        }).setView([-8.55, 115.8], 9);

        window.leafletMap = map;

        window.L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
          maxZoom: 19,
          errorTileUrl: 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7'
        }).addTo(map);

        // Puntos + info (para popups y para el click desde la lista)
        const points = [
          { n: "Ubud", c: [-8.5069, 115.2625], d: "Selva, arrozales, cascadas, templos. Aqu√≠ se viene a cargar bater√≠as (y a sudar con estilo).", emoji: "üêí" },
          { n: "Uluwatu", c: [-8.8149, 115.1147], d: "Acantilados, templo al atardecer y olas. Cuidado con los monos: roban m√°s que Hacienda.", emoji: "üåä" },
          { n: "Seminyak", c: [-8.6880, 115.1610], d: "Beach clubs, cenas guapas y sunsets. La zona donde todo parece caro por deporte.", emoji: "üç∏" },
          { n: "Gili Trawangan", c: [-8.3503, 116.0386], d: "Agua cristal, snorkel y tortugas. Cero coches, cero estr√©s, cero excusas.", emoji: "üê¢" },
          { n: "Lombok", c: [-8.8955, 116.2952], d: "M√°s salvaje y tranquilo. Playas brutales y vibes de 'esto s√≠ es vacaciones'.", emoji: "ü••" }
        ];

        // Icono mejorado con animaci√≥n y pulso
        const createIcon = (index) => {
          return window.L.divIcon({
            className: 'custom-marker-icon',
            html: `
              <div class="marker-pulse" style="
                position: absolute;
                width: 24px;
                height: 24px;
                background: rgba(245, 158, 11, 0.3);
                border-radius: 50%;
                animation: pulse-marker 2s infinite;
                top: -12px;
                left: -12px;
              "></div>
              <div style="
                position: relative;
                width: 20px;
                height: 20px;
                background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
                border-radius: 50%;
                border: 3px solid white;
                box-shadow: 0 0 20px rgba(245, 158, 11, 0.8), 0 0 40px rgba(245, 158, 11, 0.4);
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 10px;
                z-index: 10;
              ">${points[index].emoji}</div>
            `,
            iconSize: [20, 20],
            iconAnchor: [10, 10]
          });
        };

        const markersByName = {};
        window.leafletMarkersByName = markersByName;

        // Crear marcadores con iconos mejorados
        points.forEach((p, idx) => {
          const title = escapeHtml(p.n);
          const desc = escapeHtml(p.d);
          const emoji = p.emoji || "üìç";

          const popupHtml = `
            <div style="
              font-family: 'Outfit', system-ui, sans-serif;
              max-width: 280px;
              padding: 4px;
            ">
              <div style="
                font-weight: 900;
                letter-spacing: 0.05em;
                text-transform: uppercase;
                font-size: 14px;
                margin-bottom: 8px;
                color: #111;
                display: flex;
                align-items: center;
                gap: 6px;
              ">
                <span style="font-size: 18px;">${emoji}</span>
                <span>${title}</span>
              </div>
              <div style="
                font-size: 13px;
                line-height: 1.5;
                color: #333;
                margin-bottom: 8px;
              ">
                ${desc}
              </div>
              <div style="
                margin-top: 8px;
                font-size: 11px;
                letter-spacing: 0.1em;
                text-transform: uppercase;
                opacity: 0.7;
                color: #666;
                border-top: 1px solid #eee;
                padding-top: 6px;
              ">
                Parada ${idx + 1} / ${points.length}
              </div>
            </div>
          `;

          const marker = window.L.marker(p.c, { 
            icon: createIcon(idx)
          }).addTo(map);

          marker.bindPopup(popupHtml, { 
            closeButton: true,
            className: 'custom-popup',
            maxWidth: 300
          });

          // Animaci√≥n al pasar el mouse sobre el marcador
          marker.on('mouseover', function() {
            this.openPopup();
          });

          markersByName[p.n] = marker;
        });

        // RUTA dibujada con estilo mejorado y animaci√≥n
        const routeCoords = points.map(p => p.c);

        const routeLine = window.L.polyline(routeCoords, {
          color: "#f59e0b",
          weight: 5,
          opacity: 0.9,
          lineJoin: "round",
          lineCap: "round",
          dashArray: "10, 15",
          className: 'route-line'
        }).addTo(map);

        // A√±adir sombra/glow a la ruta
        const routeShadow = window.L.polyline(routeCoords, {
          color: "#fbbf24",
          weight: 8,
          opacity: 0.3,
          lineJoin: "round",
          lineCap: "round",
          className: 'route-shadow'
        }).addTo(map);

        // Asegurar que la sombra est√© detr√°s de la l√≠nea principal
        routeShadow.bringToBack();
        routeLine.bringToFront();

        window.leafletRouteLine = routeLine;

        // Ajusta el mapa para que se vean todos los puntos con padding generoso
        setTimeout(() => {
          try {
            const bounds = routeLine.getBounds();
            map.fitBounds(bounds, { 
              padding: [60, 60],
              maxZoom: 10
            });
          } catch (e) {
            console.warn('Error al ajustar bounds:', e);
          }
        }, 300);

        // Click en la lista: centra y abre popup con animaci√≥n
        const stopsEl = document.getElementById("stops");
        if (stopsEl && !stopsEl.dataset.bound) {
          stopsEl.dataset.bound = "1";
          stopsEl.addEventListener("click", (ev) => {
            const btn = ev.target && ev.target.closest && ev.target.closest("[data-stop]");
            if (!btn) return;
            const name = btn.getAttribute("data-stop");
            if (!name || !window.leafletMarkersByName || !window.leafletMarkersByName[name]) return;

            const marker = window.leafletMarkersByName[name];
            const latlng = marker.getLatLng();

            // Animaci√≥n suave al centrar
            map.flyTo(latlng, Math.max(map.getZoom(), 12), {
              animate: true,
              duration: 1.2
            });

            // Abrir popup despu√©s de la animaci√≥n
            setTimeout(() => {
              marker.openPopup();
              // Efecto de "bounce" visual en el marcador
              const iconEl = marker._icon;
              if (iconEl) {
                iconEl.style.transform = 'scale(1.3)';
                setTimeout(() => {
                  iconEl.style.transition = 'transform 0.3s ease-out';
                  iconEl.style.transform = 'scale(1)';
                }, 200);
              }
            }, 600);
          });
        }

        // Ocultar loading cuando todo est√© listo
        setTimeout(() => {
          if (loadingEl) {
            loadingEl.classList.add('opacity-0');
            setTimeout(() => loadingEl.classList.add('hidden'), 300);
          }
        }, 800);

        // Importante al entrar por navegaci√≥n: fuerza el recalculo del tama√±o
        setTimeout(() => { 
          if (window.leafletMap) {
            try {
              window.leafletMap.invalidateSize(); 
            } catch (e) {
              console.warn('Error al recalcular tama√±o del mapa:', e);
            }
          }
        }, 200);

      } catch (e) {
        console.error('Error al inicializar el mapa:', e);
        if (loadingEl) loadingEl.classList.add('hidden');
        if (errorEl) {
          errorEl.classList.remove('hidden');
          errorEl.classList.add('flex');
        }
      }
    }

    document.addEventListener('DOMContentLoaded', loadMap);
    document.addEventListener('astro:page-load', loadMap);
    document.addEventListener('astro:after-swap', loadMap);
    document.addEventListener('astro:before-swap', cleanupMap);
  </script>
</Layout>

<style is:global>
  .leaflet-container { 
    background: #0a0a0a !important; 
    cursor: grab; 
  }
  
  .leaflet-container:active {
    cursor: grabbing;
  }

  /* Estilos para los marcadores personalizados */
  .custom-marker-icon {
    background: transparent !important;
    border: none !important;
  }

  /* Animaci√≥n de pulso para los marcadores */
  @keyframes pulse-marker {
    0% {
      transform: scale(1);
      opacity: 0.8;
    }
    50% {
      transform: scale(1.8);
      opacity: 0.2;
    }
    100% {
      transform: scale(2.2);
      opacity: 0;
    }
  }

  /* Estilos mejorados para los popups */
  .leaflet-popup-content-wrapper {
    background: rgba(255, 255, 255, 0.98) !important;
    backdrop-filter: blur(10px) !important;
    border-radius: 12px !important;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3), 0 0 20px rgba(245, 158, 11, 0.2) !important;
    padding: 0 !important;
  }

  .leaflet-popup-content {
    margin: 12px 16px !important;
    line-height: 1.5 !important;
  }

  .leaflet-popup-tip {
    background: rgba(255, 255, 255, 0.98) !important;
    box-shadow: 0 3px 14px rgba(0, 0, 0, 0.2) !important;
  }

  .leaflet-popup-close-button {
    color: #666 !important;
    font-size: 20px !important;
    padding: 8px !important;
    transition: all 0.2s ease !important;
  }

  .leaflet-popup-close-button:hover {
    color: #f59e0b !important;
    transform: scale(1.2);
  }

  /* Estilos para la l√≠nea de ruta */
  .route-line {
    filter: drop-shadow(0 0 8px rgba(245, 158, 11, 0.6));
    animation: route-glow 3s ease-in-out infinite;
  }

  .route-shadow {
    filter: blur(4px);
  }

  @keyframes route-glow {
    0%, 100% {
      opacity: 0.9;
    }
    50% {
      opacity: 1;
    }
  }

  /* Hover effect en los botones de paradas */
  #stops button:hover {
    background: rgba(245, 158, 11, 0.1);
    border-left-color: rgba(245, 158, 11, 0.6);
    transform: translateX(4px);
    transition: all 0.2s ease;
  }

  #stops button:hover .absolute {
    box-shadow: 0 0 20px rgba(245, 158, 11, 0.8);
    transform: scale(1.2);
    transition: all 0.2s ease;
  }

  @keyframes fade-in { 
    from { opacity: 0; transform: translateY(10px); } 
    to { opacity: 1; transform: translateY(0); } 
  }
  
  .animate-fade-in { 
    animation: fade-in 1.5s ease-out forwards; 
  }
</style>
